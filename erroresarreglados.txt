# ERRORES DE FUNCIONALIDAD ARREGLADOS

## Error 1: Variable no definida en bloque except
- **Archivo:** api/web/controlador_usuarios.py
- **Línea:** 21
- **Problema:** Se usaba `except:` sin capturar la excepción, y luego se intentaba usar `e`
- **Arreglo:** Cambiado a `except Exception as e:`

## Error 2: Variable no inicializada antes del try
- **Archivo:** api/web/controlador_usuarios.py
- **Línea:** 6-26
- **Problema:** Las variables `ret` y `code` podían no estar definidas si ocurría una excepción temprana
- **Arreglo:** Inicializadas antes del bloque try: `ret = {"status":"ERROR"}` y `code = 500`

## Error 3: Código HTTP 800 inválido
- **Archivo:** api/web/rutas_usuarios.py
- **Línea:** 51
- **Problema:** Se retornaba código HTTP 800 que no existe
- **Arreglo:** Cambiado a código 200 (éxito)

## Error 4 y 5: Falta de validación en request.json
- **Archivo:** api/web/rutas_usuarios.py
- **Líneas:** 37-42 y 44-51
- **Problema:** Se accedía directamente a `request.json` y a `login_json["token"]` sin validar
- **Arreglo:** Añadida validación:
  - `if not request.is_json:` -> retorna 400
  - `if "token" not in login_json:` -> retorna 400

## Error 6: Retorno inconsistente de tipos en validar_token
- **Archivo:** api/web/funciones_token.py
- **Líneas:** 25-30
- **Problema:** Retornaba `False` en caso de error, pero el código esperaba `None`
- **Arreglo:** Cambiado `return False` por `return None` en ambos bloques except

## Error 7: Variables de entorno no validadas
- **Archivo:** api/web/bd.py
- **Líneas:** 4-9
- **Problema:** Si faltaba alguna variable de entorno, la conexión fallaba silenciosamente
- **Arreglo:** Añadido bucle que verifica todas las variables requeridas y lanza ValueError si falta alguna

## Error 8: Código semántico incorrecto en alta_usuario
- **Archivo:** api/web/controlador_usuarios.py
- **Línea:** 47
- **Problema:** Retornaba 200 con "status":"ERROR" cuando usuario ya existe
- **Arreglo:** Cambiado código de 200 a 409 (Conflict)

## Error 9: Conversión de precio sin validación
- **Archivo:** api/web/rutas_videojuegos.py
- **Línea:** 57
- **Problema:** `float(videojuego_json["precio"])` podía fallar si el precio era inválido
- **Arreglo:** Añadido try/except que retorna 400 con mensaje "Precio invalido"

## Error 10: Comparación confusa en Comprobar_token_invalidado
- **Archivo:** api/web/controlador_token.py
- **Línea:** 59
- **Problema:** `not baneado == 0` es confuso por precedencia de operadores
- **Arreglo:** Cambiado a `if baneado != 0:`

## Error 11: TypeError potencial en concatenación SQL
- **Archivo:** api/web/controlador_videojuegos.py
- **Línea:** 55
- **Problema:** Concatenación directa de `id` en consulta SQL causaba TypeError si era entero
- **Arreglo:** Cambiado a consulta parametrizada: `WHERE id = %s` con tupla `(id,)`

## Error 12: Select de videojuegos no se poblaba
- **Archivo:** api/web/static/comentarios.html
- **Líneas:** 21-23, 64-82
- **Problema:** Faltaba función para cargar videojuegos y poblar el select, por lo que aparecía vacío
- **Arreglo:** Añadida función `pedirVideojuegos()` que llama a `/api/videojuegos/` y llena el select con los juegos disponibles

## Error 13: Campos incorrectos al guardar comentario
- **Archivo:** api/web/static/comentarios.html
- **Líneas:** 25-36
- **Problema:** Se enviaban campos incorrectos en el JSON: `"usuario"` en lugar de `"id_usuario"` y faltaba `"id_videojuego"`
- **Arreglo:** Cambiado el JSON para enviar `id_usuario`, `id_videojuego` y `contenido` correctamente

## Error 14: Backend esperaba id_usuario numérico pero frontend enviaba nombre de usuario
- **Archivo:** api/web/controlador_comentarios.py y api/web/rutas_comentarios.py
- **Líneas:** 12-26, 7-22
- **Problema:** El formulario enviaba el nombre de usuario (texto) pero el backend esperaba `id_usuario` (número entero), causando error 500 por FOREIGN KEY fallida
- **Arreglo:** Modificado `insertar_comentario()` para recibir `username` y buscar el ID对应的 usuario usando nueva función `obtener_usuario_por_nombre()`

## Error 15: Validación faltante en campos del formulario de comentarios
- **Archivo:** api/web/rutas_comentarios.py
- **Líneas:** 9-22
- **Problema:** No se validaba que los campos existieran, causando KeyError si faltaba alguno
- **Arreglo:** Añadido `data.get()` con validación y retorno 400 si faltan datos

## Error 16: Error del servidor no visible para el usuario
- **Archivo:** api/web/static/comentarios.html
- **Líneas:** 25-47
- **Problema:** El mensaje de error siempre era "El comentario no ha podido almacenarse" sin mostrar el motivo real
- **Arreglo:** Añadida validación de campos vacíos y muestra del mensaje de error del servidor: `Error: ${result.mensaje || ...}`

---

## RESUMEN DE CAMBIOS POR ARCHIVO

| Archivo | Cambios |
|---------|---------|
| api/web/controlador_usuarios.py | 3 cambios |
| api/web/controlador_videojuegos.py | 1 cambio |
| api/web/rutas_usuarios.py | 2 cambios |
| api/web/funciones_token.py | 1 cambio |
| api/web/bd.py | 1 cambio |
| api/web/rutas_videojuegos.py | 1 cambio |
| api/web/controlador_token.py | 1 cambio |
| api/web/controlador_comentarios.py | 1 cambio |
| api/web/rutas_comentarios.py | 1 cambio |
| api/web/static/comentarios.html | 3 cambios |
| api/web/rutas_ficheros.py | 1 cambio |
| api/web/static/ficheros.html | 2 cambios |

Total: 18 errores de funcionalidad corregidos

## Error 17: Endpoint de visualización de archivos
- **Archivo:** api/web/rutas_ficheros.py
- **Líneas:** 22-29
- **Problema:** El endpoint usaba send_from_directory() para servir archivos
- **Arreglo:** Cambiado para usar subprocess.getoutput("cat") para devolver el contenido como texto plano

## Error 18: Frontend para visualizar archivos
- **Archivo:** api/web/static/ficheros.html
- **Líneas:** 40-72
- **Problema:** El frontend usaba textarea para archivos binarios
- **Arreglo:** Cambiado para usar fetch con response.text() y mostrar el contenido en el textarea

